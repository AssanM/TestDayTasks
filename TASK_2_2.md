Мы работаем с [тайловой картой](https://github.com/s-prozorov/TestDayTasks/blob/main/TASK_1_1.md), состоящей из нескольких слоёв.  
Реализованы слои **поверхности**, **объектов** и **регионов**, а также базовый сетевой слой на LiteNetLib для UDP-запросов и push-событий через MessagePack.  

На текущем этапе необходимо спроектировать и реализовать механизм **динамических подписок на области карты** для клиентов, которые перемещаются по миру.  

---

## Необходимый функционал

- **Подписка на область вокруг позиции игрока.**  
  Клиент задаёт область (например, прямоугольник или круг), и сервер отправляет события только для объектов и регионов, пересекающих эту область.  

- **Динамическое обновление подписки.**  
  При перемещении игрока зона подписки сдвигается. Сервер должен:
  - добавить в подписку объекты и регионы, попавшие в новую область;  
  - удалить из подписки объекты и регионы, вышедшие за пределы старой области.  

- **Push-события для подписанной области.**  
  Сервер рассылает клиентам сообщения об изменениях объектов и регионов, затрагивающих их подписанную зону.  

- **Оптимизация трафика и производительности.**  
  - Пакетирование нескольких событий в один UDP-пакет;  
  - Использование пространственных структур (R-Tree, чанки) для быстрого определения пересекающихся объектов;  
  - Поддержка большого числа клиентов с минимальными накладными расходами.  

---

## Свойства и контракты

- **Запрос подписки:**
  - `SubscribeAreaRequest`: ID клиента, координаты зоны (центр + радиус или прямоугольник).  
- **Ответ сервера:**
  - `SubscribeAreaResponse`: текущее состояние объектов и регионов в зоне.  
- **События:**
  - `ObjectAdded`, `ObjectUpdated`, `ObjectDeleted`  
  - `RegionAdded`, `RegionDeleted`  
- **Отписка:**
  - `UnsubscribeAreaRequest` — прекращение получения обновлений.  

> Все контракты сериализуются через MemoryPack.  

---

## Обратить внимание на следующие аспекты

- **Динамика зон.** Область подписки постоянно меняется при перемещении клиента. Сервер должен корректно обновлять подписки и фильтровать события.  
- **Производительность.** Проверка пересечения событий с зонами клиентов должна быть эффективной даже при тысячах объектов и сотнях подписанных клиентов.  
- **Согласованность.** Клиенты получают только актуальные события, нет пропусков или дублирования.  
- **Расширяемость.** В будущем можно добавлять новые типы событий и фильтры без существенного изменения архитектуры.  

---

## Критерии приёмки

- Клиенты могут подписываться и динамически обновлять зоны подписки при перемещении.  
- Push-события об изменениях объектов и регионов корректно рассылаются только тем клиентам, у которых зона пересекается с изменениями.  
- Агрегация событий работает, несколько изменений отправляются в одном пакете.  
- Контракты корректно сериализуются/десериализуются через MemoryPack.  
- Модуль покрыт unit-тестами и интеграционными тестами, включая:
  - движение клиентов;  
  - пересечение зоны с множеством объектов;  
  - удаление/добавление объектов и регионов в зоне подписки.
